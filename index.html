<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><!-- molt-animated-snow -->Tahoe Snow Report</title>
  <meta name="description" content="Snow report dashboard for Lake Tahoe ski resorts." />
  <style>
    :root{--bg:#0b1220;--card:#121b2e;--muted:#9fb0d0;--text:#e8eefc;--accent:#7dd3fc;--good:#34d399;--warn:#fbbf24;--bad:#fb7185;--border:rgba(255,255,255,.08)}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 600px at 20% 0%,rgba(167,139,250,.25),transparent 60%),radial-gradient(900px 500px at 80% 10%,rgba(125,211,252,.22),transparent 55%),var(--bg);color:var(--text)}
    header{padding:28px 18px 10px;max-width:1100px;margin:0 auto}
    h1{margin:0 0 6px;font-size:28px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:14px;line-height:1.4}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
    .pill{border:1px solid var(--border);background:rgba(255,255,255,.03);padding:8px 10px;border-radius:999px;font-size:13px;color:var(--muted)}
    .pill b{color:var(--text);font-weight:600}
    main{max-width:1100px;margin:0 auto;padding:14px 18px 40px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{grid-column:span 6;background:rgba(18,27,46,.9);border:1px solid var(--border);border-radius:16px;padding:14px 14px 12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    @media (max-width:860px){.card{grid-column:span 12}}
    .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .name{font-size:18px;margin:0}
    .meta{color:var(--muted);font-size:12px;margin-top:4px}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--muted);white-space:nowrap}
    .badge.good{color:var(--good)}
    .badge.warn{color:var(--warn)}
    .badge.bad{color:var(--bad)}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .stat{border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(255,255,255,.02)}
    .stat .k{color:var(--muted);font-size:12px}
    .stat .v{font-size:18px;margin-top:4px}
    .links{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    footer{max-width:1100px;margin:0 auto;padding:0 18px 26px;color:var(--muted);font-size:12px}
    .note{border-top:1px solid var(--border);padding-top:14px;margin-top:18px;line-height:1.5}
    .small{font-size:11px;opacity:.95}
    .err{color:var(--bad)}
  

/* molt-animated-snow: motion + snowfall */
:root{--molt-accent:#7dd3fc;--molt-accent2:#a78bfa;--molt-bg:#0b1220;}
body{background:radial-gradient(1200px 800px at 20% 10%, rgba(125,211,252,.18), transparent 60%),
             radial-gradient(900px 700px at 80% 0%, rgba(167,139,250,.14), transparent 55%),
             linear-gradient(180deg, #050814, var(--molt-bg));}
#snow-canvas{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.75;mix-blend-mode:screen;}
.container{position:relative;z-index:1;}
.header{animation:molt-float 6s ease-in-out infinite;}
@keyframes molt-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.resort{transform:translateY(10px);opacity:0;animation:molt-in .7s cubic-bezier(.2,.9,.2,1) forwards;will-change:transform,opacity;}
.resort:nth-child(1){animation-delay:.05s}
.resort:nth-child(2){animation-delay:.10s}
.resort:nth-child(3){animation-delay:.15s}
.resort:nth-child(4){animation-delay:.20s}
.resort:nth-child(5){animation-delay:.25s}
.resort:nth-child(6){animation-delay:.30s}
.resort:nth-child(7){animation-delay:.35s}
.resort:nth-child(8){animation-delay:.40s}
.resort:nth-child(9){animation-delay:.45s}
.resort:nth-child(10){animation-delay:.50s}
@keyframes molt-in{to{transform:translateY(0);opacity:1}}
.resort:hover{transform:translateY(-2px) scale(1.01);box-shadow:0 18px 50px rgba(0,0,0,.35);}
.badge{position:relative;overflow:hidden;}
.badge::after{content:'';position:absolute;inset:-40% -60%;background:linear-gradient(120deg, transparent 35%, rgba(255,255,255,.22), transparent 65%);
             transform:translateX(-60%) rotate(12deg);animation:molt-sheen 3.8s ease-in-out infinite;}
@keyframes molt-sheen{0%,55%{transform:translateX(-60%) rotate(12deg);opacity:0}70%{opacity:1}100%{transform:translateX(60%) rotate(12deg);opacity:0}}
.stat-value{display:inline-block;min-width:2ch;}
#stormToggle{position:fixed;right:16px;bottom:16px;z-index:2;display:flex;gap:10px;align-items:center;
  padding:10px 12px;border-radius:999px;background:rgba(15,23,42,.72);backdrop-filter:blur(10px);
  border:1px solid rgba(148,163,184,.25);color:#e2e8f0;font-size:13px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
#stormToggle input{accent-color:var(--molt-accent);}
body.storm #snow-canvas{opacity:1;}
body.storm::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(800px 500px at 50% 0%, rgba(56,189,248,.18), transparent 60%),
             radial-gradient(900px 600px at 10% 20%, rgba(167,139,250,.14), transparent 55%);}
body.storm .header{animation:molt-float 3.5s ease-in-out infinite;}
@media (prefers-reduced-motion: reduce){
  #snow-canvas{display:none;}
  .header,.resort,.badge::after{animation:none !important;}
  .resort{opacity:1;transform:none;}
  #stormToggle{display:none;}
}

</style>
</head>
<body>

  <canvas id="snow-canvas" aria-hidden="true"></canvas>
  <label id="stormToggle" title="Storm Mode: more snow + extra motion">
    <input id="stormMode" type="checkbox" />
    <span>Storm Mode</span>
  </label>

  <header>
    <h1>Tahoe Snow Report</h1>
    <div class="sub">This page renders resort snow stats from <code>data/snow.json</code>. Update that JSON and the dashboard updates. No backend required.</div>
    <div class="bar">
      <div class="pill">Last updated: <b id="updated">—</b></div>
      <div class="pill">Source: <b id="source">—</b></div>
      <div class="pill">Status: <b id="status">Loading…</b></div>
    </div>
  </header>

  <main>
    <div id="grid" class="grid"></div>
    <div class="note small">
      <div><b>Heads up:</b> This repo ships with placeholder values. Wire <code>data/snow.json</code> to your preferred provider (or a scheduled job) for real numbers.</div>
    </div>
  </main>

  <footer>
    <div class="note">
      <div><b>Disclaimer:</b> Verify conditions with the resort before you plan your day.</div>
    </div>
  </footer>

<script>
  const fmtIn = (n) => (n === null || n === undefined || n === '') ? '—' : `${n}"`;
  const fmtPct = (n) => (n === null || n === undefined || n === '') ? '—' : `${n}%`;
  const badgeClass = (snow24) => {
    if (snow24 === null || snow24 === undefined) return '';
    if (snow24 >= 6) return 'good';
    if (snow24 >= 2) return 'warn';
    return 'bad';
  };

  function card(resort){
    const el = document.createElement('section');
    el.className = 'card';

    const snow24 = resort.snow_24h_in;
    const badge = document.createElement('div');
    badge.className = `badge ${badgeClass(snow24)}`;
    badge.textContent = (snow24 === null || snow24 === undefined) ? '24h: —' : `24h: ${snow24}"`;

    el.innerHTML = `
      <div class="top">
        <div>
          <h2 class="name">${resort.name}</h2>
          <div class="meta">${resort.region || 'Lake Tahoe'} • Elevation: ${resort.elevation_ft ?? '—'} ft</div>
        </div>
      </div>
      <div class="stats">
        <div class="stat"><div class="k">24h snow</div><div class="v">${fmtIn(resort.snow_24h_in)}</div></div>
        <div class="stat"><div class="k">72h snow</div><div class="v">${fmtIn(resort.snow_72h_in)}</div></div>
        <div class="stat"><div class="k">Base depth</div><div class="v">${fmtIn(resort.base_depth_in)}</div></div>
        <div class="stat"><div class="k">Open trails</div><div class="v">${resort.trails_open ?? '—'} / ${resort.trails_total ?? '—'}</div></div>
        <div class="stat"><div class="k">Open lifts</div><div class="v">${resort.lifts_open ?? '—'} / ${resort.lifts_total ?? '—'}</div></div>
        <div class="stat"><div class="k">Terrain open</div><div class="v">${fmtPct(resort.terrain_open_pct)}</div></div>
      </div>
      <div class="links">
        ${resort.report_url ? `<a href="${resort.report_url}" target="_blank" rel="noopener">Official report</a>` : ''}
        ${resort.webcam_url ? `<a href="${resort.webcam_url}" target="_blank" rel="noopener">Webcams</a>` : ''}
      </div>
    `;

    el.querySelector('.top').appendChild(badge);
    return el;
  }

  async function load(){
    const status = document.getElementById('status');
    try{
      const res = await fetch('./data/snow.json', {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      document.getElementById('updated').textContent = data.updated_at || '—';
      document.getElementById('source').textContent = data.source || '—';
      status.textContent = 'OK';

      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      (data.resorts || []).forEach(r => grid.appendChild(card(r)));

      if(!data.resorts || data.resorts.length === 0){
        grid.innerHTML = `<div class="err">No resorts found in /api/snow.</div>`;
      }
    }catch(e){
      status.textContent = 'Error';
      document.getElementById('grid').innerHTML = `<div class="err">Failed to load /api/snow: ${e.message}</div>`;
    }
  }

  load();


// molt-animated-snow: counters + snowfall
(function(){
  const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const body = document.body;
  const toggle = document.getElementById('stormMode');
  if(toggle){
    const saved = localStorage.getItem('moltStormMode');
    if(saved === '1'){ toggle.checked = true; body.classList.add('storm'); }
    toggle.addEventListener('change', ()=>{
      body.classList.toggle('storm', toggle.checked);
      localStorage.setItem('moltStormMode', toggle.checked ? '1' : '0');
    });
  }

  function animateNumber(el, to){
    if(prefersReduced) { el.textContent = String(to); return; }
    const fromText = (el.textContent||'').replace(/[^0-9.-]/g,'');
    const from = Number(fromText || 0);
    const start = performance.now();
    const dur = 650;
    const fmt = (v)=>{
      const suffix = (el.dataset.suffix||'');
      return Math.round(v) + suffix;
    };
    function tick(t){
      const p = Math.min(1, (t-start)/dur);
      const ease = 1 - Math.pow(1-p, 3);
      const v = from + (to-from)*ease;
      el.textContent = fmt(v);
      if(p<1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  // Hook into existing render: after resorts render, animate stat values
  const _renderResorts = window.renderResorts;
  if(typeof _renderResorts === 'function'){
    window.renderResorts = function(resorts){
      _renderResorts(resorts);
      document.querySelectorAll('.stat .value, .stat-value').forEach(el=>{
        const raw = (el.textContent||'').trim();
        const m = raw.match(/(-?\d+(?:\.\d+)?)/);
        if(!m) return;
        const num = Number(m[1]);
        const suffix = raw.replace(m[1],'');
        el.dataset.suffix = suffix;
        el.classList.add('stat-value');
        animateNumber(el, num);
      });
    }
  }

  // Snowfall canvas
  const canvas = document.getElementById('snow-canvas');
  if(!canvas || prefersReduced) return;
  const ctx = canvas.getContext('2d');
  let w,h,flakes=[];
  function resize(){
    w = canvas.width = window.innerWidth * devicePixelRatio;
    h = canvas.height = window.innerHeight * devicePixelRatio;
  }
  window.addEventListener('resize', resize);
  resize();

  function makeFlake(){
    const storm = body.classList.contains('storm');
    const r = (storm? (Math.random()*2.2+0.8) : (Math.random()*1.6+0.6)) * devicePixelRatio;
    return {
      x: Math.random()*w,
      y: -20*devicePixelRatio,
      r,
      vx: (Math.random()*0.6-0.3) * devicePixelRatio,
      vy: (Math.random()*(storm?2.6:1.8) + (storm?1.2:0.8)) * devicePixelRatio,
      a: Math.random()*Math.PI*2,
      va: (Math.random()*0.02+0.005)
    };
  }
  for(let i=0;i<140;i++) flakes.push(makeFlake());

  function step(){
    const storm = body.classList.contains('storm');
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = 'rgba(226,232,240,.85)';
    for(const f of flakes){
      f.a += f.va;
      f.x += f.vx + Math.sin(f.a)*0.25*devicePixelRatio;
      f.y += f.vy;
      if(f.y > h+30*devicePixelRatio){
        f.y = -20*devicePixelRatio;
        f.x = Math.random()*w;
      }
      if(f.x < -30*devicePixelRatio) f.x = w+30*devicePixelRatio;
      if(f.x > w+30*devicePixelRatio) f.x = -30*devicePixelRatio;
      ctx.beginPath();
      ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
      ctx.fill();
    }
    // occasional lightning-ish flash in storm mode
    if(storm && Math.random() < 0.002){
      ctx.fillStyle = 'rgba(255,255,255,.08)';
      ctx.fillRect(0,0,w,h);
    }
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
})();

</script>
</body>
</html>
